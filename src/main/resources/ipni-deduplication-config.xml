<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:p="http://www.springframework.org/schema/p"
	xmlns:c="http://www.springframework.org/schema/c"
	xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.1.xsd">

	<bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="location">
			<value>ipni-deduplication.properties</value>
		</property>
	</bean>
	
	<!--  where the lucene indexes are stored -->
	<bean id="lucene_directory" class="java.lang.String">
		<constructor-arg value="target/deduplicator"/>
	</bean> 

	<!-- Input and output files -->
	<bean id="inputfile" class="java.io.File">
		<constructor-arg value="${datadir}/input.tsv" />
	</bean>

	<bean id="outputfile" class="java.io.File">
		<constructor-arg value="${datadir}/output.txt" />
	</bean>
	<bean id="reportfile" class="java.io.File">
		<constructor-arg value="${datadir}/report.txt" />
	</bean>
	<bean id="topcopyfile" class="java.io.File">
		<constructor-arg value="${datadir}/topcopy.txt" />
	</bean>

	<!-- Matchers:
		These define how two values should be considered matches -->
		
	<bean id="exactMatcher" class="org.kew.shs.dedupl.matchers.ExactMatcher" />
	
	<bean id="levenshteinMatcher" class="org.kew.shs.dedupl.matchers.LevenshteinMatcher" 
		p:maxDistance="1"/>

	<bean id="ocrCanonicaliserMatcher" class="org.kew.shs.dedupl.matchers.OcrCanonicaliserMatcher" />

	<bean id="epithetMatcher" class="org.kew.shs.dedupl.matchers.CompositeAnyMatcher">
		<property name="matchers">
			<util:list>
				<ref bean="levenshteinMatcher"/>
				<ref bean="ocrCanonicaliserMatcher"/>
			</util:list>
		</property>
	</bean>	
	
	<bean id="commonTokensMatcher" class="org.kew.shs.dedupl.matchers.CommonTokensMatcher" 
		p:minRatio="0.5"/>

	<bean id="authorCommonTokensMatcher" class="org.kew.shs.dedupl.matchers.AuthorCommonTokensMatcher" 
		p:minRatio="0.5"/>

	<bean id="capitalLettersMatcher" class="org.kew.shs.dedupl.matchers.CapitalLettersMatcher" 
		p:minRatio="0.5"/>

	<bean id="numberMatcher" class="org.kew.shs.dedupl.matchers.NumberMatcher" 
		p:minRatio="0.5"/>

	<bean id="ngramMatcher" class="org.kew.shs.dedupl.matchers.NGramMatcher" 
		p:minRatio="0.5" p:nGramLength="2"/>
	
	<bean id="yearMatcher" class="org.kew.shs.dedupl.matchers.InitialSubstringMatcher" 
		p:prefixSize="3"/>

	<bean id="alwaysMatchingMatcher" class="org.kew.shs.dedupl.matchers.AlwaysMatchingMatcher" />

	<!-- Transformers: 
		These carry out defined transformations to clean values before storage -->
	<bean id="genusCleaner"
		class="org.kew.shs.dedupl.transformers.StripNonAlphabeticCharactersTransformer" />

	<bean id="epithetCleaner"
		class="org.kew.shs.dedupl.transformers.EpithetTransformer" />

	<bean id="yearCleaner" 
		class="org.kew.shs.dedupl.transformers.ZeroToBlankTransformer" />

	<bean id="collationCleaner" 
		class="org.kew.shs.dedupl.transformers.CompositeTransformer">
		<property name="transformers">
			<util:list id="1">
				<bean id="icollationCleaner" 
					class="org.kew.shs.dedupl.transformers.StripNonAlphanumericCharactersTransformer" />
				<bean id="rcollationCleaner" 
					class="org.kew.shs.dedupl.transformers.RomanNumeralTransformer" />
			</util:list>
		</property>
	</bean>
		

	<!-- Column based properties, these define: column index of the property 
		in the input file, how these should be cleaned prior to storage (using 
		references to transformers as defined above), if they should 
		be used in the select to find possible matches, how these should match 
		(using references to matchers as defined above) -->
	<util:list id="columnProperties">
		<bean class="org.kew.shs.dedupl.configuration.Property" 
			p:name="family"
			p:columnIndex="1"
			p:matcher-ref="exactMatcher"
			p:useInSelect="true"/>
		<bean class="org.kew.shs.dedupl.configuration.Property" 
			p:name="infra_family"
			p:columnIndex="2"
			p:matcher-ref="exactMatcher"
			p:useInSelect="true"/>
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="genus"
			p:columnIndex="3"
			p:matcher-ref="exactMatcher"
			p:transformer-ref="genusCleaner"
			p:useInSelect="true"/>
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="infra_genus"
			p:columnIndex="4"
			p:matcher-ref="exactMatcher"
			p:transformer-ref="genusCleaner"
			p:useInSelect="true"/>
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="species"
			p:columnIndex="5"
			p:matcher-ref="epithetMatcher"
			p:transformer-ref="epithetCleaner"
			p:useInSelect="true"
			p:indexLength="true"
			p:indexInitial="true"/>
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="infra_species"
			p:columnIndex="6"
			p:matcher-ref="epithetMatcher"
			p:transformer-ref="epithetCleaner"
			p:useInSelect="true"
			p:indexLength="true"
			p:indexInitial="true"/>		
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="rank"
			p:columnIndex="7"
			p:matcher-ref="exactMatcher"
			p:transformer-ref="epithetCleaner"
			p:useInSelect="true"/>
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="basionymAuthor"
			p:columnIndex="8"
			p:matcher-ref="authorCommonTokensMatcher"
			p:blanksMatch="true"/>
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="author"
			p:columnIndex="9"
			p:matcher-ref="authorCommonTokensMatcher"/>
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="publication"
			p:columnIndex="10"
			p:matcher-ref="capitalLettersMatcher"
			p:blanksMatch="true"/>
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="collation"
			p:columnIndex="11"
			p:transformer-ref="collationCleaner"
			p:matcher-ref="numberMatcher"
			p:indexOriginal="true"
			p:blanksMatch="true"/>
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="year"
			p:columnIndex="12"
			p:matcher-ref="yearMatcher"
			p:blanksMatch="true"
			p:transformer-ref="yearCleaner"/>
		<bean class="org.kew.shs.dedupl.configuration.Property"
			p:name="std_score"
			p:columnIndex="13"
			p:matcher-ref="alwaysMatchingMatcher"
			p:useInSelect="false"/>
	</util:list>
	
	<bean id="config" class="org.kew.shs.dedupl.configuration.DeduplicationConfiguration"
		p:inputFile-ref="inputfile"
		p:inputFileDelimiter="&#09;"
		p:outputFileDelimiter="&#09;"
		p:outputFileIdDelimiter=","
		p:outputFile-ref="outputfile"
		p:properties-ref="columnProperties"
		p:loadReportFrequency="5000"

		p:writeComparisonReport="true"
		p:reportFile-ref="reportfile"

		p:writeTopCopyReport="true"
		p:topCopyFile-ref="topcopyfile"
		p:scoreFieldName="std_score"/>
		
</beans>
